<html>

<head>
  <title>Computer Graphics Assessment 4</title>
</head>

<style>
  body {
    margin: 0;
  }

  canvas {
    width: 100%;
    height: 100%;
  }
</style>

<body>
  <link rel = "shortcut icon" href = "#">

  <style>
    body {
      font-family: Monospace;
      background-color: #000;
      color: #fff;
      margin: 0px;
      overflow: hidden;
    }

    #info {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: left;
    }
  </style>

  <div id = "info">
    <p>
      Computer Graphics - Assessment 4<br>
      Natasha<br>
    </p>
  </div>

  <script type = "importmap">
			{
				"imports": {
					"three": "./build/three.module.js"
				}
			}
	</script>

  <script type = "module">

    import * as THREE from 'three';
    import { OrbitControls } from './build/OrbitControls.js';
    import { Perlin } from './build/perlin.js';
    import { OBJLoader } from './build/loaders/OBJLoader.js';
    import { MTLLoader } from './build/loaders/MTLLoader.js';

    // Create scene
    var scene = new THREE.Scene();
    var ratio = window.innerWidth / window.innerHeight;

    // Camera setup
    var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
    var cameraTarget = {x:0, y:0, z:0};
    camera.position.y = 70;
    camera.position.z = 1000;
    //camera.rotation.y = Math.PI / 2999;


    var cameralight = new THREE.PointLight( new THREE.Color(1,1,1), 1 );
 	  cameralight.name = 'Light';
    camera.add( cameralight );
 	  scene.add(camera);
    scene.background = new THREE.Color(0,0,0);

    // Renderer setup
    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Clears the scene when parameters are updated
    function ClearScene() {
      for (let i = scene.children.length - 1; i >= 0; i--) {
        if (scene.children[i].type == "Mesh") {
          scene.remove(scene.children[i]);
        }
      }
    }

    // Frame information
    var FrameMatrix = [];
    var subFrames = 10;
    var currFrame = 0;
    var vertices = [];
    var positions = [];
    var planeWidth = 5000;
    var planeLength = 5000;

    function CreateScene() {

      //Creates the Plane
      var planeGeometry = new THREE.PlaneGeometry(planeWidth, planeLength, 256, 256);
      var planeMaterial = new THREE.MeshBasicMaterial();
      planeMaterial.wireframe = true;
      planeMaterial.side = THREE.DoubleSide;
      planeMaterial.color = new THREE.Color(0.694, 1, 0.431);
      var terrain = new THREE.Mesh(planeGeometry,planeMaterial);
      scene.add(terrain);
      
      //Adds noise to plane
      var perlin = new Perlin();
      var peak = 60;
      var smoothing = 1000;
      vertices = terrain.geometry.attributes.position.array;
      for (var i = 0; i <= vertices.length; i += 3) {
          vertices[i+2] = peak * perlin.noise(
              vertices[i]/smoothing, 
              vertices[i+1]/smoothing
          );
      }
      terrain.geometry.attributes.position.needsUpdate = true;
      terrain.geometry.computeVertexNormals();
      terrain.geometry.rotateX(Math.PI/2);
    
      //LOAD LAMPS
      var mtlloader=new MTLLoader();
      mtlloader.setPath( '../models/' )
      mtlloader.load( 'streetLamp.mtl', function ( materials ) 
      {
        materials.preload();
        var objload=new OBJLoader();
        objload.setMaterials( materials )
        objload.setPath( '../models/' )
        objload.load( 'streetLamp.obj', function ( object ) 
        {
          var box3 = new THREE.Box3();
          box3.setFromObject (object);
          var CenterBB= new THREE.Vector3();
          var SizeBB = new THREE.Vector3();
          box3.getCenter(CenterBB);
          box3.getSize(SizeBB);
          for ( var i = 0, l = object.children.length; i < l; i ++ ) 
          {
            object.children[i].material.color= new THREE.Color(1,1,1);
          }

          for (var i = 0; i < treeNumber; i++) {
            var clone = object.clone();
            var raycaster = new THREE.Raycaster();
            var posx = THREE.MathUtils.randFloat(-2500,2500);
            var posz = THREE.MathUtils.randFloat(-2500,2500);
            var rayPos = new THREE.Vector3(posx,100,posz);
            var rayDir = new THREE.Vector3(0, -1, 0);
            var ray = new THREE.Ray(rayPos, rayDir);
            raycaster.ray = ray;
            let intersect = raycaster.intersectObject(terrain);

            //var pos = intersect.point;
            //console.log(pos);
            //clone.scale.set(100,100,100);
            //clone.position.set(intersect.point.x,intersect.point.y,intersect.point.z);
            //trees.push(object);
            //scene.add(clone);
            
            var pos = intersect[0].point;
            console.log(pos);
            clone.scale.set(100,100,100);
            clone.position.set(intersect[0].point.x,intersect[0].point.y,intersect[0].point.z);
            //trees.push(object);
            scene.add(clone);
          }
        });
      } );
    

      //LOAD TREES
      var trees = [];
      var treeNumber = 10;

      function spawnTrees() {
        var treeModel;
        var treeMaterial1;
        var bodyMaterial;
        var mtlload = new MTLLoader();
        mtlload.setPath('../models/')
        mtlload.load('Gledista_Triacanthos_2.mtl', function(materials) 
        {
          materials.preload();
          var objload = new OBJLoader();
          objload.setMaterials(materials)
          objload.setPath('../models/')
          objload.load('Gledista_Triacanthos_2.obj', function(object) 
          {
            var box3 = new THREE.Box3();
            box3.setFromObject(object);
            var CenterBB = new THREE.Vector3();
            var SizeBB = new THREE.Vector3();
            box3.getCenter(CenterBB);
            box3.getSize(SizeBB);

            // Change colour
            /*
            bodyMaterial = materials.materials.Body;
            var red = Math.random();
            var green = Math.random();
            var blue = Math.random();
            changeColor(bodyMaterial, new THREE.Color(red, green, blue));*/

            for(var i = 0, l = object.children.length; i < l; i ++) 
            {
              object.children[i].material.color = new THREE.Color(1,1,1);
            }

            object.castShadow = true;
            object.receiveShadow = true;
          });
        });
      }

    }

    CreateScene();


    // Changes material colour
    /*
		function changeColor(material, newColor)
		{
			material.color = newColor;
			material.needsUpdate = true;
		}*/

    

    /*function spawnTree() 
		{
		  	//var spawnIndex = Math.floor(Math.random() * spawnPositions.length);
		  	//var spawnPosition = spawnPositions[spawnIndex];
    		var tree = treeModel.clone();
        tree.position.set(10,10,10);
    		//tree.position.copy(spawnPosition);
    		//tree.direction = spawnDirection;
    		trees.push(tree);
    		scene.add(tree);
		}

    function cube() {
        var cubeGeo = new THREE.BoxGeometry(10,10);
        var cubeMat = new THREE.MeshBasicMaterial();
        var cube = new THREE.Mesh(cubeGeo, cubeMat);
        cube.position.set(vertices[10]);
        cube.scale.set(100,100);
        //console.log(max);
        scene.add(cube);
    } */

    

    var controls = new OrbitControls(camera, renderer.domElement);

    // Final update loop
    var MyUpdateLoop = function () {
      renderer.render(scene, camera);
      controls.update();

      requestAnimationFrame(MyUpdateLoop);
    };

    requestAnimationFrame(MyUpdateLoop);

    function handleKeyDown(event) {
    }

  window.addEventListener('keydown', handleKeyDown, false);

    // Called when the window is resized
    var MyResize = function () {
      var width = window.innerWidth;
      var height = window.innerHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.render(scene, camera);
    };

    // Link the resize of the window to the camera update
    window.addEventListener('resize', MyResize);
  </script>
</body>

</html>